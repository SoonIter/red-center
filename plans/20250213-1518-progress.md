# 红中 (Red Center) - 实施进度记录

## 环境信息
- Rust 1.93.1 (stable)
- Bevy 0.18.0
- 像素字体: assets/fonts/pixel.ttf (Zpix v3.1.8)

## Bevy 0.18 vs 0.17 API 变更记录 (踩过的坑)

1. **WindowResolution**: 不再支持 `(f64, f64).into()`, 需要用 `(u32, u32).into()`
2. **Msaa**: 不再是 Resource, 变成了 Component, 需要挂在 Camera 实体上
3. **ChildSpawner 类型变更**: `EntityCommands::with_children()` 回调参数类型从 `ChildSpawner` 变为 `ChildSpawnerCommands`
   - `ChildSpawner` = `RelatedSpawner<'w, ChildOf>` (用于 World 直接操作)
   - `ChildSpawnerCommands` = `RelatedSpawnerCommands<'w, ChildOf>` (用于 Commands 操作)
   - **不在 prelude 中**, 需要从 `bevy::ecs::hierarchy::ChildSpawnerCommands` 导入
4. **Sprite**: 用 `Sprite::from_color(color, size)` 创建纯色矩形
5. **Text2d**: 世界空间文字, `Text2d::new("text")`, 自动 require TextFont/TextColor/Transform 等
6. **UI Text**: UI 中用 `Text::new("text")`, 不是 Text2d
7. **Observer 模式**: Event 必须 derive `Clone`, 用 `commands.trigger()` 触发, `add_observer()` 注册
8. **Observer 参数**: 观察者函数第一个参数用 `On<Event>`, 不是 `Trigger<Event>`

## 已完成

### Phase 1: 项目骨架与状态机 ✅
- [x] Cargo.toml (bevy 0.18, rand 0.8)
- [x] src/main.rs - 窗口 1280x720, ImagePlugin::default_nearest(), 标题 "红中 Red Center"
- [x] src/plugins/mod.rs - RedCenterPluginGroup
- [x] src/plugins/game.rs - AppState {Menu, Playing, GameOver}, PlayPhase {Selecting, Scoring, RoundResult}, Camera2d + Msaa::Off
- [x] src/plugins/{tile,board,input,scoring,ui}.rs - 空 Plugin 骨架
- [x] src/components/mod.rs, tile.rs, board.rs, game.rs
- [x] src/events.rs - 所有事件定义
- [x] src/resources.rs - GameState, TileWall, PlayerHand, PlayBoard, SubRound
- [x] cargo check 通过

### Phase 2: 麻将牌数据模型与渲染 ✅
- [x] components/tile.rs - TileSuit, TileId (label/suit_color/to_index/from_index), Tile, TileLocation, TileSelected
- [x] Tile::generate_full_set() 生成 136 张牌
- [x] plugins/tile.rs - spawn_tiles (136 个 Sprite 实体 + Text2d 子实体), update_tile_positions
- [x] 资源初始化: TileWall, PlayerHand, PlayBoard
- [x] 开局从牌山摸 hand_size 张到待选区
- [x] cargo check 通过

### Phase 3: UI 布局 ✅
- [x] plugins/ui.rs - 完整 UI 代码:
  - [x] 菜单页: 标题 "红中" + "开始游戏" 按钮
  - [x] 游戏页: 小丑区 / 得分区 / 出牌区(14个空槽) / 牌山 / 待选区 / 按钮行(菜单/出牌/弃牌)
  - [x] 游戏结束页: "游戏结束" + 关卡信息 + "重新开始" 按钮
  - [x] 按钮事件处理: menu_button_system, game_button_system, gameover_button_system
  - [x] 按钮悬停/按下颜色反馈: button_hover_system
  - [x] 分数显示更新: update_score_display, update_wall_count
  - [x] 状态清理: OnExit cleanup 系统
- [x] cargo check 通过

### Phase 4: 核心游戏循环 ✅
- [x] plugins/input.rs: handle_tile_click
  - [x] 鼠标坐标 → 世界坐标 (camera.viewport_to_world_2d)
  - [x] AABB 碰撞检测 → 选牌 (toggle TileSelected component)
- [x] plugins/board.rs:
  - [x] on_play_tiles (Observer, On<PlayTilesEvent>): 选中牌 Hand→Board, 补牌, plays_remaining--
  - [x] on_discard_tiles (Observer, On<DiscardTilesEvent>): 选中牌 Hand→Discarded, 补牌, discards_remaining--
  - [x] check_phase_transition: plays==0 or 14张满 → PlayPhase::Scoring
- [x] 牌选中视觉反馈 (上移15px, 已在 update_tile_positions 中实现)
- [x] 退出 Playing 状态时 cleanup_tiles 清理所有牌实体
- [x] cargo check 通过

### Phase 5: 和牌判定与计分 ✅
- [x] plugins/scoring.rs:
  - [x] `evaluate_hand(tiles: &[TileId]) -> HandResult` 纯函数
  - [x] [u8; 34] 计数数组 + 递归回溯 (remove_melds)
  - [x] 牌型:
    - 平和(×1), 和了(×1, 标准和但无特殊牌型)
    - 断幺九(×2)
    - 一气通贯(×3)
    - 对对和(×4), 七对子(×4)
    - 混一色(×5)
    - 清一色(×8)
    - 国士无双(×13)
    - 未和牌(底分=牌数, ×1)
  - [x] calculate_score 系统 (OnEnter Scoring)
  - [x] evaluate_round_result 系统 (OnEnter RoundResult) → 过关或 GameOver
  - [x] 7 个单元测试全部通过
- [x] cargo check 通过, cargo test 通过

## 待完成

### Phase 6: Roguelike 关卡进度
- 盲注系统: 小盲注(100×N) / 大盲注(200×N) / Boss(400×N) — 已在 resources.rs 实现
- advance_sub_round / advance_level — 已在 resources.rs 实现
- 小关切换: 清空出牌区, 牌山保留 — 已在 scoring.rs evaluate_round_result 实现
- 过关: 重新生成 136 张牌 — 待验证
- 失败: → GameOver — 已实现
- 小关开始横幅动画 (可选)

### Phase 7: 打磨与可选功能
- 按钮悬停/按下动画效果优化
- 出牌/弃牌时的牌移动动画
- 音效
- 小丑区道具系统 (未来扩展)

## 项目文件结构 (当前)
```
red-center/
├── Cargo.toml
├── assets/fonts/pixel.ttf
├── plans/
│   ├── structure.png          # UI 原型图
│   └── 20250213-1518-progress.md  # 本文件
└── src/
    ├── main.rs
    ├── events.rs
    ├── resources.rs
    ├── components/
    │   ├── mod.rs
    │   ├── tile.rs
    │   ├── board.rs
    │   └── game.rs
    └── plugins/
        ├── mod.rs
        ├── game.rs
        ├── tile.rs             # spawn/update/cleanup tiles
        ├── board.rs            # play/discard observers + phase transition
        ├── input.rs            # mouse click → tile selection
        ├── scoring.rs          # hand evaluation + score calculation + round result
        └── ui.rs               # menu/game/gameover UI + button interactions
```
